<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<title>å¯µå¯µå”¯è·¡ å¯µç‰©ç¾å®¹é ç´„æ—¥æ›†</title>
<link rel="stylesheet"
	href="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.10.2/fullcalendar.min.css" />
<link rel="stylesheet"
	href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css" />
<link rel="stylesheet"
	href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />
<link rel="stylesheet" href="/css/frontend_index_styles.css">
<link rel="stylesheet" href="/slick/slick.css" />
<link rel="stylesheet" href="/slick/slick-theme.css" />

<script
	src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script
	src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"></script>
<script
	src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
<script
	src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.10.2/fullcalendar.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>


<style>
#calendar {
	max-width: 900px;
	margin: 0 auto;
}

.completed-booking {
	background-color: #4CAF50 !important;
	border-color: #4CAF50 !important;
}

.ongoing-booking {
	background-color: #FFA500 !important;
	border-color: #FFA500 !important;
}

.cancelled-booking {
	background-color: #ADADAD !important;
	border-color: #ADADAD !important;
}

.rating {
	display: flex;
	flex-direction: row-reverse;
	justify-content: flex-end;
}

.rating>input {
	display: none;
}

.rating>label {
	position: relative;
	width: 1.1em;
	font-size: 2em;
	color: #ddd;
	cursor: pointer;
}

.rating>label:before {
	content: "\2605";
	position: absolute;
	opacity: 1;
}

.rating>label:hover:before, .rating>label:hover ~ label:before {
	color: #FFD700;
}

.rating>input:checked ~ label:before {
	color: #FFD700;
}

.ready-booking {
	background-color: #007BFF !important;
	border-color: #007BFF !important;
}

#bookingList {
	margin-top: 30px;
}

.star-rating {
	color: #FFD700;
}
</style>
</head>
<body>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å¯µå¯µå”¯è·¡å‹å–„å¹³å°</title>
<link rel="stylesheet" href="/css/frontend_index_styles.css">
<link rel="stylesheet" href="/slick/slick.css" />
<link rel="stylesheet" href="/slick/slick-theme.css" />
</head>
<body>
	<header>
		<h1>
			<a th:href="@{/}">å¯µå¯µå”¯è·¡ ServPET</a>
		</h1>
	</header>

	<nav>
		<div class="dropdown">
			<button class="dropbtn">é—œæ–¼å¹³å°</button>
			<div class="dropdown-content">
				<a th:href="@{/é é¢ä½å€æ”¾é€™}">å¹³å°ä»‹ç´¹</a> <a
					th:href="@{/member/cs-issues/add}">å•é¡Œåæ‡‰</a>
			</div>
		</div>
		<div class="dropdown">
			<button class="dropbtn">æœ€æ–°æ¶ˆæ¯</button>
			<div class="dropdown-content">
				<a th:href="@{/member/event/list}">å¹³å°å…¬å‘Šæ¶ˆæ¯</a>
			</div>
		</div>
		<div class="dropdown">
			<button class="dropbtn">å¯µç‰©å•†åŸ</button>
			<div class="dropdown-content">
				<a th:href="@{/é é¢ä½å€æ”¾é€™}">å•†å“åˆ—è¡¨</a> <a th:href="@{/é é¢ä½å€æ”¾é€™}">è³¼ç‰©è»Š</a>
			</div>
		</div>
		<div class="dropdown">
			<button class="dropbtn">å¯µç‰©ç¾å®¹</button>
			<div class="dropdown-content">
				<a th:href="@{/pg/showAllPgSvcItem}">å¯µç‰©ç¾å®¹æœå‹™</a> <a th:href="@{/pg}">é ç´„</a>
			</div>
		</div>
		<div class="dropdown">
			<button class="dropbtn">å¯µç‰©ä¿æ¯</button>
			<div class="dropdown-content">
				<a th:href="@{/ps/psList}">å¯µç‰©ä¿æ¯æœå‹™</a>
			</div>
		</div>
		<div class="dropdown">
			<button class="dropbtn">æœƒå“¡å°ˆå€</button>
			<div class="dropdown-content">
				<a th:href="@{/profile}">æœƒå“¡å€‹äººè³‡è¨Š</a>
				<a th:href="@{/pets}">å¯µç‰©è³‡è¨Š</a>
				<a th:href="@{/ntfy/member}">æœƒå“¡è¨Šæ¯åŒ£</a>
				<a th:href="@{/mebPdo/mebPdo}">å•†åŸè¨‚å–®</a>
				<a th:href="@{/booking/calendar}">æˆ‘çš„å¯µç‰©ç¾å®¹æœˆæ›†</a>
				<a th:href="@{/pdFav/list}">å•†å“æ”¶è—</a> <a th:href="@{/pgFav/list}">å¯µç‰©ç¾å®¹å¸«æ”¶è—</a>
				<a th:href="@{/é é¢ä½å€æ”¾é€™}">å¯µç‰©ä¿æ¯æ”¶è—</a>
				<a th:href="@{/é é¢ä½å€æ”¾é€™}">æˆ‘çš„éŒ¢åŒ…</a>
				<a th:href="@{/apply/create}">æˆç‚ºç¾å®¹å¸«/ä¿æ¯</a>
			</div>
		</div>
		<div class="dropdown">
			<button class="dropbtn">ç™»å…¥</button>
			<div class="dropdown-content">
				<a th:href="@{/login}">æœƒå“¡ç™»å…¥</a> <a th:href="@{/admin/login}">å¾Œå°ç™»å…¥</a>
			</div>
		</div>
	</nav>



	<main>

		<div class="container mt-5">
			<h1 class="text-center mb-4">æˆ‘çš„å¯µç‰©ç¾å®¹æœˆæ›† ğŸ•</h1>
			<div class="mb-3">
				<div class="d-flex justify-content-around">
					<span class="text-end"> <i
						class="fas fa-circle text-primary"></i> é ç´„æº–å‚™ä¸­.. <i
						class="fas fa-circle text-warning"></i> é€²è¡Œä¸­.. <i
						class="fas fa-circle text-success"></i> å·²å®Œæˆ,å¯é€è©•åƒ¹å›‰!
					</span>
				</div>
			</div>

			<ul class="nav nav-tabs" id="myTab" role="tablist">
				<li class="nav-item" role="presentation"><a
					class="nav-link active" id="calendar-tab" data-toggle="tab"
					href="#calendar" role="tab" aria-controls="calendar"
					aria-selected="true">æœˆæ›†è¦–åœ–</a></li>
				<li class="nav-item" role="presentation"><a class="nav-link"
					id="list-tab" data-toggle="tab" href="#bookingList" role="tab"
					aria-controls="list" aria-selected="false">åˆ—è¡¨è¦–åœ–</a></li>
			</ul>
			<div class="tab-content" id="myTabContent">
				<div class="tab-pane fade show active" id="calendar" role="tabpanel"
					aria-labelledby="calendar-tab">
					<div id="calendarView"></div>
				</div>
				<div class="tab-pane fade" id="bookingList" role="tabpanel"
					aria-labelledby="list-tab">
					<table class="table table-striped">
						<thead>
							<tr>
								<th>å¯µç‰©å</th>
								<th>ç¾å®¹å¸«</th>
								<th>é ç´„æ—¥æœŸ</th>
								<th>é ç´„é …ç›®</th>
								<th>é ç´„æ™‚æ®µ</th>
								<th>ç‹€æ…‹</th>
								<th>è©•åˆ†</th>
								<th>è©•åˆ†å…§å®¹</th>
								<th>æ“ä½œ</th>
							</tr>
						</thead>
						<tbody id="bookingTableBody">
							<!-- é ç´„åˆ—è¡¨å°‡åœ¨é€™è£¡å‹•æ…‹ç”Ÿæˆ -->
						</tbody>
					</table>
				</div>
			</div>
		</div>

		<!-- ä¿®æ”¹é ç´„è¡¨å–® -->
		<div class="modal fade" id="updateForm" tabindex="-1" role="dialog">
			<div class="modal-dialog" role="document">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title">ä¿®æ”¹é ç´„</h5>
						<button type="button" class="close" data-dismiss="modal">&times;</button>
					</div>
					<div class="modal-body">
						<form id="updateBookingForm">
							<input type="hidden" id="updatePgoId" name="pgoId" />
							<div class="form-group">
								<label>é ç´„æ—¥æœŸ</label> <input type="date" id="updateBookingDate"
									name="bookingDate" class="form-control" required />
							</div>
							<div class="form-group">
								<label>é ç´„æ™‚æ®µ</label> <select id="updateBookingTime"
									name="bookingTime" class="form-control" required>
									<option value="0">æ—©</option>
									<option value="1">ä¸­</option>
									<option value="2">æ™š</option>
								</select>
							</div>
							<button type="submit" class="btn btn-primary">ä¿®æ”¹é ç´„</button>
							<button type="button" class="btn btn-danger" id="cancelBooking">å–æ¶ˆé ç´„</button>
						</form>
					</div>
				</div>
			</div>
		</div>

		<!-- è©•åƒ¹è¡¨å–® -->
		<div class="modal fade" id="ratingForm" tabindex="-1" role="dialog">
			<div class="modal-dialog" role="document">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title">æœå‹™è©•åƒ¹</h5>
						<button type="button" class="close" data-dismiss="modal">&times;</button>
					</div>
					<div class="modal-body">
						<form id="submitRating">
							<input type="hidden" id="ratingPgoId" name="pgoId" />
							<div class="rating mb-3">
								<input type="radio" id="star5" name="star" value="5" /><label
									for="star5">â˜…</label> <input type="radio" id="star4"
									name="star" value="4" /><label for="star4">â˜…</label> <input
									type="radio" id="star3" name="star" value="3" /><label
									for="star3">â˜…</label> <input type="radio" id="star2"
									name="star" value="2" /><label for="star2">â˜…</label> <input
									type="radio" id="star1" name="star" value="1" /><label
									for="star1">â˜…</label>
							</div>
							<div class="form-group">
								<label>è©•åƒ¹å…§å®¹</label>
								<textarea id="ratingComment" name="comment" class="form-control"
									required></textarea>
							</div>
							<button type="submit" class="btn btn-primary">æäº¤è©•åƒ¹</button>
						</form>
					</div>
				</div>
			</div>
		</div>

	</main>

	<footer>
		<p>Copyright Â© 2024 ServPET å¯µå¯µå”¯è·¡ All Rights Reserved.</p>
	</footer>

	<script th:inline="javascript">
        $(document).ready(function() {
            const timeSlotMap = {
                '0': 'æ—©ä¸Š',
                '1': 'ä¸­åˆ',
                '2': 'æ™šä¸Š'
            };
            const statusMap = {
                '0': 'é ç´„æº–å‚™ä¸­',
                '1': 'å·²å®Œæˆ',
                '2': 'é€²è¡Œä¸­',
                '3': 'å·²å–æ¶ˆ'
            };
            let bookings = /*[[${bookings}]]*/ [];

            function initializeCalendar() {
                $('#calendarView').fullCalendar({
                    header: {
                        left: 'prev,next today',
                        center: 'title',
                        right: 'month,agendaWeek,agendaDay'
                    },
                    events: function(start, end, timezone, callback) {
                        var events = bookings.map(function(booking) {
                            var className = '';
                            switch(booking.bookingStatus) {
                                case '1': className = 'completed-booking'; break;
                                case '2': className = 'ongoing-booking'; break;
                                case '3': className = 'cancelled-booking'; break;
                                default: className = 'ready-booking';
                            }
                            var timeSlot = timeSlotMap[booking.bookingTime] || booking.bookingTime;
                            return {
                                id: booking.pgoId,
                                title: 'å¯µç‰©å: '+booking.petName  + '\n' + 'ç¾å®¹å¸«: ' + booking.pgName + '\n' + 
                                       'é ç´„æ™‚æ®µ: ' + timeSlot,
                                start: booking.bookingDate,
                                className: className,
                                bookingStatus: booking.bookingStatus
                            };
                        });
                        callback(events);
                    },
                    eventClick: function(calEvent, jsEvent, view) {
                        handleEventClick(calEvent);
                    }
                });
            }

            function initializeBookingList() {
                const tableBody = $('#bookingTableBody');
                tableBody.empty();
                bookings.forEach(function(booking) {
                    const row = $('<tr>').attr('data-pgo-id', booking.pgoId);
                    row.append($('<td>').text(booking.petName));
                    row.append($('<td>').text(booking.pgName));
                    row.append($('<td>').text(booking.bookingDate));
                    row.append($('<td>').text(booking.svcName));
                    row.append($('<td>').text(timeSlotMap[booking.bookingTime] || booking.bookingTime));
                    row.append($('<td>').text(statusMap[booking.bookingStatus]));
        
                    // Add star rating display
                    const ratingCell = $('<td>');
                    if (booking.star) {
                        const stars = 'â˜…'.repeat(booking.star) + 'â˜†'.repeat(5 - booking.star);
                        ratingCell.html(`<span class="star-rating">${stars}</span>`);
                    }
                    row.append(ratingCell);
        
                    row.append($('<td>').text(booking.ratingComment || ''));
        
                    const actionCell = $('<td>');
                    if (booking.bookingStatus === '1') {
                        actionCell.append($('<button>').addClass('btn btn-sm btn-primary mr-2').text('é»æˆ‘è©•åƒ¹').click(function() {
                            $('#ratingPgoId').val(booking.pgoId);
                            $('#ratingForm').modal('show');
                        }));
                    } else if (booking.bookingStatus !== '2' && booking.bookingStatus !== '3') {
                        actionCell.append($('<button>').addClass('btn btn-sm btn-warning mr-2').text('ä¿®æ”¹é ç´„').click(function() {
                            handleEventClick({id: booking.pgoId, start: booking.bookingDate, bookingStatus: booking.bookingStatus});
                        }));
                    }
                    row.append(actionCell);
        
                    tableBody.append(row);
                });
            }


            function handleEventClick(calEvent) {
                if (calEvent.bookingStatus === '1') {
                    $('#ratingPgoId').val(calEvent.id);
                    $('#ratingForm').modal('show');
                } else if (calEvent.bookingStatus === '2') {
                	Swal.fire('è¨‚å–®é€²è¡Œä¸­ä¸èƒ½ä¿®æ”¹æ™‚é–“!');
                } else if (calEvent.bookingStatus !== '3') {
                    const selectedDate = moment(calEvent.start).format('YYYY-MM-DD');
                    const today = moment().format('YYYY-MM-DD');
                    
                    $('#updatePgoId').val(calEvent.id).data('status', calEvent.bookingStatus);
                    $('#updateBookingDate').val(selectedDate);
                    $('#updateBookingDate').attr('min', today);
                    $('#updateForm').modal('show');
                }
            }

            initializeCalendar();
            initializeBookingList();

            $('#updateBookingForm').submit(function(e) {
                e.preventDefault();

                Swal.fire({
                    title: 'ç¢ºå®šè¦ä¿®æ”¹é€™å€‹é ç´„å—ï¼Ÿ',
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'ç¢ºå®š',
                    cancelButtonText: 'å–æ¶ˆ'
                }).then((result) => {
                    if (result.isConfirmed) {
                        var formData = new FormData(this);
                        var bookingDate = $('#updateBookingDate').val();
                        var bookingTime = $('#updateBookingTime').val();
                        var pgoId = $('#updatePgoId').val();
                        $.ajax({
                            url: '/booking/update/' + pgoId,
                            method: 'PUT',
                            data: {
                                bookingDate: bookingDate,
                                bookingTime: bookingTime
                            },
                            success: function(response) {
                                $('#updateForm').modal('hide');
                                Swal.fire({
                                    title: 'æˆåŠŸï¼',
                                    text: 'é ç´„ä¿®æ”¹æˆåŠŸï¼',
                                    icon: 'success',
                                    timer: 2000,
                                    timerProgressBar: true,
                                    willClose: () => {
                                        setTimeout(() => {
                                            location.reload();
                                        }, 1000); // 2ç§’å¾Œé‡æ–°è¼‰å…¥é é¢
                                    }
                                });
                            },
                            error: function(xhr, status, error) {
                                Swal.fire('ä¿®æ”¹å¤±æ•—ï¼', xhr.responseText, 'error');
                            }
                        });
                    }
                });
            });

            $('#cancelBooking').click(function() {
                Swal.fire({
                    title: 'ç¢ºå®šè¦å–æ¶ˆé€™å€‹é ç´„å—ï¼Ÿ',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'ç¢ºå®š',
                    cancelButtonText: 'å–æ¶ˆ'
                }).then((result) => {
                    if (result.isConfirmed) {
                        $.ajax({
                            url: '/booking/cancel/' + $('#updatePgoId').val(),
                            method: 'POST',
                            success: function(response) {
                                $('#updateForm').modal('hide');
                                Swal.fire({
                                    title: 'æˆåŠŸï¼',
                                    text: 'é ç´„å–æ¶ˆæˆåŠŸï¼',
                                    icon: 'success',
                                    timer: 2000,
                                    timerProgressBar: true,
                                    willClose: () => {
                                        setTimeout(() => {
                                            location.reload();
                                        }, 1000); // 2ç§’å¾Œé‡æ–°è¼‰å…¥é é¢
                                    }
                                });
                            },
                            error: function(xhr, status, error) {
                                Swal.fire('å–æ¶ˆå¤±æ•—ï¼', xhr.responseText, 'error');
                            }
                        });
                    }
                });
            });

            $('#submitRating').submit(function(e) {
                e.preventDefault();

                Swal.fire({
                    title: 'ç¢ºå®šæäº¤è©•åƒ¹å—ï¼Ÿ',
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'æäº¤',
                    cancelButtonText: 'å–æ¶ˆ'
                }).then((result) => {
                    if (result.isConfirmed) {
                        $.ajax({
                            url: '/booking/rate/' + $('#ratingPgoId').val(),
                            method: 'POST',
                            data: $(this).serialize(),
                            success: function(response) {
                                $('#ratingForm').modal('hide');
                                Swal.fire({
                                    title: 'æˆåŠŸï¼',
                                    text: 'è©•åƒ¹æäº¤æˆåŠŸï¼',
                                    icon: 'success',
                                    timer: 2000,
                                    timerProgressBar: true,
                                    willClose: () => {
                                        setTimeout(() => {
                                            location.reload();
                                        }, 1000); // 2ç§’å¾Œé‡æ–°è¼‰å…¥é é¢
                                    }
                                });
                            },
                            error: function(xhr, status, error) {
                                Swal.fire('è©•åƒ¹æäº¤å¤±æ•—ï¼', xhr.responseText, 'error');
                            }
                        });
                    }
                });
            });

        });
    </script>
</body>

</html>

